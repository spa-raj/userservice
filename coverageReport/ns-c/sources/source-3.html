


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > JpaRegisteredClientRepository</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.vibevault.userservice.security.services</a>
</div>

<h1>Coverage Summary for Class: JpaRegisteredClientRepository (com.vibevault.userservice.security.services)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JpaRegisteredClientRepository</td>
<td class="coverageStat">
  <span class="percent">
    62.5%
  </span>
  <span class="absValue">
    (10/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    37.5%
  </span>
  <span class="absValue">
    (6/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    59.6%
  </span>
  <span class="absValue">
    (56/94)
  </span>
</td>
</tr>
  <tr>
    <td class="name">JpaRegisteredClientRepository$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    64.7%
  </span>
  <span class="absValue">
    (11/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    37.5%
  </span>
  <span class="absValue">
    (6/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    60%
  </span>
  <span class="absValue">
    (57/95)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.vibevault.userservice.security.services;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;import com.vibevault.userservice.security.jackson.CustomSecurityJacksonModule;
&nbsp;import com.vibevault.userservice.security.models.Client;
&nbsp;import com.vibevault.userservice.security.repositories.ClientRepository;
&nbsp;import org.springframework.security.jackson.SecurityJacksonModules;
&nbsp;import org.springframework.security.oauth2.core.AuthorizationGrantType;
&nbsp;import org.springframework.security.oauth2.core.ClientAuthenticationMethod;
&nbsp;import org.springframework.security.oauth2.server.authorization.client.RegisteredClient;
&nbsp;import org.springframework.security.oauth2.server.authorization.client.RegisteredClientRepository;
&nbsp;import org.springframework.security.oauth2.server.authorization.jackson.OAuth2AuthorizationServerJacksonModule;
&nbsp;import org.springframework.security.oauth2.server.authorization.settings.ClientSettings;
&nbsp;import org.springframework.security.oauth2.server.authorization.settings.TokenSettings;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;import tools.jackson.core.type.TypeReference;
&nbsp;import tools.jackson.databind.json.JsonMapper;
&nbsp;import tools.jackson.databind.jsontype.BasicPolymorphicTypeValidator;
&nbsp;
&nbsp;@Component
&nbsp;public class JpaRegisteredClientRepository implements RegisteredClientRepository {
&nbsp;    private final ClientRepository clientRepository;
&nbsp;    private final JsonMapper jsonMapper;
&nbsp;
<b class="fc">&nbsp;    public JpaRegisteredClientRepository(ClientRepository clientRepository) {</b>
<b class="fc">&nbsp;        Assert.notNull(clientRepository, &quot;clientRepository cannot be null&quot;);</b>
<b class="fc">&nbsp;        this.clientRepository = clientRepository;</b>
&nbsp;
<b class="fc">&nbsp;        ClassLoader classLoader = JpaRegisteredClientRepository.class.getClassLoader();</b>
&nbsp;        // Configure validator to allow all application and Spring Security types
<b class="fc">&nbsp;        BasicPolymorphicTypeValidator.Builder validatorBuilder = BasicPolymorphicTypeValidator.builder()</b>
<b class="fc">&nbsp;                .allowIfBaseType(Object.class)</b>
<b class="fc">&nbsp;                .allowIfSubTypeIsArray()</b>
<b class="fc">&nbsp;                .allowIfSubType(&quot;com.vibevault.userservice.&quot;)</b>
<b class="fc">&nbsp;                .allowIfSubType(&quot;org.springframework.security.&quot;)</b>
<b class="fc">&nbsp;                .allowIfSubType(&quot;java.&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        this.jsonMapper = JsonMapper.builder()</b>
<b class="fc">&nbsp;                .addModules(SecurityJacksonModules.getModules(classLoader, validatorBuilder))</b>
<b class="fc">&nbsp;                .addModule(new OAuth2AuthorizationServerJacksonModule())</b>
<b class="fc">&nbsp;                .addModule(new CustomSecurityJacksonModule())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void save(RegisteredClient registeredClient) {
<b class="nc">&nbsp;        Assert.notNull(registeredClient, &quot;registeredClient cannot be null&quot;);</b>
<b class="nc">&nbsp;        this.clientRepository.save(toEntity(registeredClient));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public RegisteredClient findById(String id) {
<b class="nc">&nbsp;        Assert.hasText(id, &quot;id cannot be empty&quot;);</b>
<b class="nc">&nbsp;        return this.clientRepository.findById(id).map(this::toObject).orElse(null);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public RegisteredClient findByClientId(String clientId) {
<b class="fc">&nbsp;        Assert.hasText(clientId, &quot;clientId cannot be empty&quot;);</b>
<b class="fc">&nbsp;        return this.clientRepository.findByClientId(clientId).map(this::toObject).orElse(null);</b>
&nbsp;    }
&nbsp;
&nbsp;    private RegisteredClient toObject(Client client) {
<b class="fc">&nbsp;        Set&lt;String&gt; clientAuthenticationMethods = StringUtils.commaDelimitedListToSet(</b>
<b class="fc">&nbsp;                client.getClientAuthenticationMethods());</b>
<b class="fc">&nbsp;        Set&lt;String&gt; authorizationGrantTypes = StringUtils.commaDelimitedListToSet(</b>
<b class="fc">&nbsp;                client.getAuthorizationGrantTypes());</b>
<b class="fc">&nbsp;        Set&lt;String&gt; redirectUris = StringUtils.commaDelimitedListToSet(</b>
<b class="fc">&nbsp;                client.getRedirectUris());</b>
<b class="fc">&nbsp;        Set&lt;String&gt; postLogoutRedirectUris = StringUtils.commaDelimitedListToSet(</b>
<b class="fc">&nbsp;                client.getPostLogoutRedirectUris());</b>
<b class="fc">&nbsp;        Set&lt;String&gt; clientScopes = StringUtils.commaDelimitedListToSet(</b>
<b class="fc">&nbsp;                client.getScopes());</b>
&nbsp;
<b class="fc">&nbsp;        RegisteredClient.Builder builder = RegisteredClient.withId(client.getId())</b>
<b class="fc">&nbsp;                .clientId(client.getClientId())</b>
<b class="fc">&nbsp;                .clientIdIssuedAt(client.getClientIdIssuedAt())</b>
<b class="fc">&nbsp;                .clientSecret(client.getClientSecret())</b>
<b class="fc">&nbsp;                .clientSecretExpiresAt(client.getClientSecretExpiresAt())</b>
<b class="fc">&nbsp;                .clientName(client.getClientName())</b>
<b class="fc">&nbsp;                .clientAuthenticationMethods(authenticationMethods -&gt;</b>
<b class="fc">&nbsp;                        clientAuthenticationMethods.forEach(authenticationMethod -&gt;</b>
<b class="fc">&nbsp;                                authenticationMethods.add(resolveClientAuthenticationMethod(authenticationMethod))))</b>
<b class="fc">&nbsp;                .authorizationGrantTypes((grantTypes) -&gt;</b>
<b class="fc">&nbsp;                        authorizationGrantTypes.forEach(grantType -&gt;</b>
<b class="fc">&nbsp;                                grantTypes.add(resolveAuthorizationGrantType(grantType))))</b>
<b class="fc">&nbsp;                .redirectUris((uris) -&gt; uris.addAll(redirectUris))</b>
<b class="fc">&nbsp;                .postLogoutRedirectUris((uris) -&gt; uris.addAll(postLogoutRedirectUris))</b>
<b class="fc">&nbsp;                .scopes((scopes) -&gt; scopes.addAll(clientScopes));</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, Object&gt; clientSettingsMap = parseMap(client.getClientSettings());</b>
<b class="fc">&nbsp;        builder.clientSettings(ClientSettings.withSettings(clientSettingsMap).build());</b>
&nbsp;
<b class="fc">&nbsp;        Map&lt;String, Object&gt; tokenSettingsMap = parseMap(client.getTokenSettings());</b>
<b class="fc">&nbsp;        builder.tokenSettings(TokenSettings.withSettings(tokenSettingsMap).build());</b>
&nbsp;
<b class="fc">&nbsp;        return builder.build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private Client toEntity(RegisteredClient registeredClient) {
<b class="nc">&nbsp;        List&lt;String&gt; clientAuthenticationMethods = new ArrayList&lt;&gt;(registeredClient.getClientAuthenticationMethods().size());</b>
<b class="nc">&nbsp;        registeredClient.getClientAuthenticationMethods().forEach(clientAuthenticationMethod -&gt;</b>
<b class="nc">&nbsp;                clientAuthenticationMethods.add(clientAuthenticationMethod.getValue()));</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;String&gt; authorizationGrantTypes = new ArrayList&lt;&gt;(registeredClient.getAuthorizationGrantTypes().size());</b>
<b class="nc">&nbsp;        registeredClient.getAuthorizationGrantTypes().forEach(authorizationGrantType -&gt;</b>
<b class="nc">&nbsp;                authorizationGrantTypes.add(authorizationGrantType.getValue()));</b>
&nbsp;
<b class="nc">&nbsp;        Client entity = new Client();</b>
<b class="nc">&nbsp;        entity.setId(registeredClient.getId());</b>
<b class="nc">&nbsp;        entity.setClientId(registeredClient.getClientId());</b>
<b class="nc">&nbsp;        entity.setClientIdIssuedAt(registeredClient.getClientIdIssuedAt() != null</b>
<b class="nc">&nbsp;                ? registeredClient.getClientIdIssuedAt()</b>
<b class="nc">&nbsp;                : java.time.Instant.now());</b>
<b class="nc">&nbsp;        entity.setClientSecret(registeredClient.getClientSecret());</b>
<b class="nc">&nbsp;        entity.setClientSecretExpiresAt(registeredClient.getClientSecretExpiresAt());</b>
<b class="nc">&nbsp;        entity.setClientName(registeredClient.getClientName());</b>
<b class="nc">&nbsp;        entity.setClientAuthenticationMethods(StringUtils.collectionToCommaDelimitedString(clientAuthenticationMethods));</b>
<b class="nc">&nbsp;        entity.setAuthorizationGrantTypes(StringUtils.collectionToCommaDelimitedString(authorizationGrantTypes));</b>
<b class="nc">&nbsp;        entity.setRedirectUris(StringUtils.collectionToCommaDelimitedString(registeredClient.getRedirectUris()));</b>
<b class="nc">&nbsp;        entity.setPostLogoutRedirectUris(StringUtils.collectionToCommaDelimitedString(registeredClient.getPostLogoutRedirectUris()));</b>
<b class="nc">&nbsp;        entity.setScopes(StringUtils.collectionToCommaDelimitedString(registeredClient.getScopes()));</b>
<b class="nc">&nbsp;        entity.setClientSettings(writeMap(registeredClient.getClientSettings().getSettings()));</b>
<b class="nc">&nbsp;        entity.setTokenSettings(writeMap(registeredClient.getTokenSettings().getSettings()));</b>
&nbsp;
<b class="nc">&nbsp;        return entity;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Map&lt;String, Object&gt; parseMap(String data) {
&nbsp;        try {
<b class="fc">&nbsp;            return this.jsonMapper.readValue(data, new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {</b>
&nbsp;            });
&nbsp;        } catch (Exception ex) {
<b class="nc">&nbsp;            throw new IllegalArgumentException(ex.getMessage(), ex);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private String writeMap(Map&lt;String, Object&gt; data) {
&nbsp;        try {
<b class="nc">&nbsp;            return this.jsonMapper.writeValueAsString(data);</b>
&nbsp;        } catch (Exception ex) {
<b class="nc">&nbsp;            throw new IllegalArgumentException(ex.getMessage(), ex);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private static AuthorizationGrantType resolveAuthorizationGrantType(String authorizationGrantType) {
<b class="fc">&nbsp;        if (AuthorizationGrantType.AUTHORIZATION_CODE.getValue().equals(authorizationGrantType)) {</b>
<b class="fc">&nbsp;            return AuthorizationGrantType.AUTHORIZATION_CODE;</b>
<b class="fc">&nbsp;        } else if (AuthorizationGrantType.CLIENT_CREDENTIALS.getValue().equals(authorizationGrantType)) {</b>
<b class="fc">&nbsp;            return AuthorizationGrantType.CLIENT_CREDENTIALS;</b>
<b class="pc">&nbsp;        } else if (AuthorizationGrantType.REFRESH_TOKEN.getValue().equals(authorizationGrantType)) {</b>
<b class="fc">&nbsp;            return AuthorizationGrantType.REFRESH_TOKEN;</b>
<b class="nc">&nbsp;        } else if (AuthorizationGrantType.DEVICE_CODE.getValue().equals(authorizationGrantType)) {</b>
<b class="nc">&nbsp;            return AuthorizationGrantType.DEVICE_CODE;</b>
&nbsp;        }
<b class="nc">&nbsp;        return new AuthorizationGrantType(authorizationGrantType);              // Custom authorization grant type</b>
&nbsp;    }
&nbsp;
&nbsp;    private static ClientAuthenticationMethod resolveClientAuthenticationMethod(String clientAuthenticationMethod) {
<b class="pc">&nbsp;        if (ClientAuthenticationMethod.CLIENT_SECRET_BASIC.getValue().equals(clientAuthenticationMethod)) {</b>
<b class="fc">&nbsp;            return ClientAuthenticationMethod.CLIENT_SECRET_BASIC;</b>
<b class="nc">&nbsp;        } else if (ClientAuthenticationMethod.CLIENT_SECRET_POST.getValue().equals(clientAuthenticationMethod)) {</b>
<b class="nc">&nbsp;            return ClientAuthenticationMethod.CLIENT_SECRET_POST;</b>
<b class="nc">&nbsp;        } else if (ClientAuthenticationMethod.NONE.getValue().equals(clientAuthenticationMethod)) {</b>
<b class="nc">&nbsp;            return ClientAuthenticationMethod.NONE;</b>
&nbsp;        }
<b class="nc">&nbsp;        return new ClientAuthenticationMethod(clientAuthenticationMethod);      // Custom client authentication method</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2026-01-10 15:25</div>
</div>
</body>
</html>
